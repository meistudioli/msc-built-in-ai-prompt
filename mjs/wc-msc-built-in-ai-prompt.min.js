import{_wcl}from"./common-lib.js";import{_wccss}from"./common-css.js";const defaults={},booleanAttrs=[],objectAttrs=[],custumEvents={ready:"msc-built-in-ai-prompt-ready",progress:"msc-built-in-ai-prompt-download-progress"},supported=!!window.LanguageModel,template=document.createElement("template");template.innerHTML=`
<style>
${_wccss}

:host {
  --display: none;

  position: relative;
  inline-size: fit-content;
  display: var(--display);
}

:host(:not([data-status=unsupported],[data-status=available])) {
  --display: block;
}

.main {
  inline-size: fit-content;
  block-size: fit-content;
}
</style>

<div class="main" ontouchstart="">
  <slot></slot>
</div>
`;class MscBuiltInAiPrompt extends HTMLElement{#data;#nodes;#config;constructor(t){super(),this.attachShadow({mode:"open",delegatesFocus:!0}),this.shadowRoot.appendChild(template.content.cloneNode(!0)),this.#data={controller:"",session:""},this.#nodes={slot:this.shadowRoot.querySelector("slot")},this.#config={...defaults,...t},this._onClick=this._onClick.bind(this)}async connectedCallback(){var{config:t,error:s}=await _wcl.getWCConfig(this);s?(console.warn(_wcl.classToTagName(this.constructor.name)+": "+s),this.remove()):(this.#config={...this.#config,...t},Object.keys(defaults).forEach(t=>this.#upgradeProperty(t)),this.#data.controller=new AbortController,s=this.#data.controller.signal,this.#nodes.slot.addEventListener("click",this._onClick,{signal:s}),await this.#statusCheck(),"available"===this.status&&this.#fireEvent(custumEvents.ready))}disconnectedCallback(){this.#data?.controller&&this.#data.controller.abort()}static get observedAttributes(){return Object.keys(defaults)}static get supportedEvents(){return Object.keys(custumEvents).map(t=>custumEvents[t])}#upgradeProperty(t){let s;MscBuiltInAiPrompt.observedAttributes.includes(t)&&(Object.prototype.hasOwnProperty.call(this,t)?(s=this[t],delete this[t]):s=booleanAttrs.includes(t)?!(!this.hasAttribute(t)&&!this.#config[t]):objectAttrs.includes(t)?this.hasAttribute(t)?this.getAttribute(t):JSON.stringify(this.#config[t]):this.hasAttribute(t)?this.getAttribute(t):this.#config[t],this[t]=s)}async#statusCheck(){this.#config.status=supported?await window.LanguageModel.availability():"unsupported",this.dataset.status=this.#config.status}get status(){return this.#config.status}get inputUsage(){return this.#data.session?.inputUsage}get inputQuota(){return this.#data.session?.inputQuota}#fireEvent(t,s){this.dispatchEvent(new CustomEvent(t,{bubbles:!0,composed:!0,...s&&{detail:s}}))}async#progress(t){var{loaded:t,total:s=1}=t,t=Math.floor(t/s*100);100===t?(this.toggleAttribute("data-progress",!1),await this.#statusCheck(),this.#fireEvent(custumEvents.ready)):(this.dataset.status="downloading",this.dataset.progress=t,this.#fireEvent(custumEvents.progress,{progress:t}))}async _onClick(){if("unsupported"===this.status)throw new Error("Current browser doesn't support Built-in AI.");await this.#statusCheck(),"downloadable"===this.status&&await this.create()}destroy(){this.#data.session?.destroy?.()}async params(){if("unsupported"===this.status)throw new Error("Current browser doesn't support Built-in AI.");return window.LanguageModel.params()}async measureInputUsage(t){if("unsupported"===this.status)throw new Error("Current browser doesn't support Built-in AI.");var s=await window.LanguageModel.create(),t=await s.measureInputUsage(t);return s.destroy(),t}async create(t={}){if("unsupported"===this.status)throw new Error("Current browser doesn't support Built-in AI.");const{multimodal:s,...e}=t;this.destroy(),this.#data.session=await window.LanguageModel.create({...e,monitor:t=>{t.addEventListener("downloadprogress",t=>{this.#progress(t)})}}),s&&this.#data.session?.append&&await this.#data.session.append(s)}async prompt(t,s={}){if("unsupported"===this.status)throw new Error("Current browser doesn't support Built-in AI.");return this.#data.session?.prompt||await this.create(),this.#data.session.prompt(t,s)}async promptStreaming(t,s={}){if("unsupported"===this.status)throw new Error("Current browser doesn't support Built-in AI.");return this.#data.session?.promptStreaming||await this.create(),this.#data.session.promptStreaming(t,s)}}const S=_wcl.supports(),T=_wcl.classToTagName("MscBuiltInAiPrompt");S.customElements&&S.shadowDOM&&S.template&&!window.customElements.get(T)&&window.customElements.define(_wcl.classToTagName("MscBuiltInAiPrompt"),MscBuiltInAiPrompt);export{MscBuiltInAiPrompt};